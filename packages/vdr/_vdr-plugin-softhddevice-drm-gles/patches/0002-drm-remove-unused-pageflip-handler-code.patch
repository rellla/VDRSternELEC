From 98c88bfd0fbfc086acc60368d4270ae0deb10f37 Mon Sep 17 00:00:00 2001
From: Andreas Baierl <ichgeh@imkreisrum.de>
Date: Tue, 27 Dec 2022 18:39:53 +0100
Subject: [PATCH 2/3] drm: remove unused pageflip handler code

Signed-off-by: Andreas Baierl <ichgeh@imkreisrum.de>
---
 0001-halve-usleeps.patch | 92 ++++++++++++++++++++++++++++++++++++++++
 video.h                  |  1 -
 video_drm.c              | 19 ---------
 3 files changed, 92 insertions(+), 20 deletions(-)
 create mode 100644 0001-halve-usleeps.patch

diff --git a/0001-halve-usleeps.patch b/0001-halve-usleeps.patch
new file mode 100644
index 0000000..1a7043f
--- /dev/null
+++ b/0001-halve-usleeps.patch
@@ -0,0 +1,92 @@
+From aa7f70da1bbdb97b87aaa798390ad9c390504ddc Mon Sep 17 00:00:00 2001
+From: Andreas Baierl <ichgeh@imkreisrum.de>
+Date: Mon, 26 Dec 2022 20:06:32 +0100
+Subject: [PATCH] halve usleeps
+
+---
+ video_drm.c | 18 +++++++++---------
+ 1 file changed, 9 insertions(+), 9 deletions(-)
+
+diff --git a/video_drm.c b/video_drm.c
+index 1dc63f3..19fd378 100644
+--- a/video_drm.c
++++ b/video_drm.c
+@@ -1217,7 +1217,7 @@ dequeue:
+ 			render->act_buf = NULL;
+ 			goto page_flip_osd;
+ 		}
+-		usleep(10000);
++		usleep(5000);
+ 	}
+ 
+ 	frame = render->FramesRb[render->FramesRead];
+@@ -1248,7 +1248,7 @@ dequeue:
+ #endif
+ avready:
+ 		if (AudioVideoReady(video_pts)) {
+-			usleep(10000);
++			usleep(5000);
+ 			if (render->Closing)
+ 				goto closing;
+ 			goto avready;
+@@ -1262,7 +1262,7 @@ audioclock:
+ 		goto closing;
+ 
+ 	if (audio_pts == (int64_t)AV_NOPTS_VALUE && !render->TrickSpeed) {
+-		usleep(20000);
++		usleep(10000);
+ 		goto audioclock;
+ 	}
+ 
+@@ -1293,7 +1293,7 @@ audioclock:
+ 			atomic_read(&render->FramesFilled), AudioUsedBytes(), Timestamp2String(audio_pts),
+ 			Timestamp2String(video_pts), VideoAudioDelay, diff);
+ #endif
+-		usleep(20000);
++		usleep(10000);
+ 		goto audioclock;
+ 	}
+ 
+@@ -1310,7 +1310,7 @@ audioclock:
+ 		render->StartCounter++;
+ 
+ 	if (render->TrickSpeed)
+-		usleep(20000 * render->TrickSpeed);
++		usleep(10000 * render->TrickSpeed);
+ 
+ 	buf->frame = frame;
+ 	render->FramesRead = (render->FramesRead + 1) % VIDEO_SURFACES_MAX;
+@@ -1643,10 +1643,10 @@ static void *DecodeHandlerThread(void *arg)
+ 			atomic_read(&render->FramesFilled) < VIDEO_SURFACES_MAX) {
+ 
+ 			if (VideoDecodeInput(render->Stream))
+-				usleep(10000);
++				usleep(5000);
+ 
+ 		} else {
+-			usleep(10000);
++			usleep(5000);
+ 		}
+ 	}
+ 	pthread_exit((void *)pthread_self());
+@@ -1884,7 +1884,7 @@ static void *FilterHandlerThread(void * arg)
+ 
+ 	while (1) {
+ 		while (!atomic_read(&render->FramesDeintFilled) && !render->Filter_Close) {
+-			usleep(10000);
++			usleep(5000);
+ 		}
+ getinframe:
+ 		if (atomic_read(&render->FramesDeintFilled)) {
+@@ -1941,7 +1941,7 @@ fillframe:
+ 					atomic_inc(&render->FramesFilled);
+ 				}
+ 			} else {
+-				usleep(10000);
++				usleep(5000);
+ 				goto fillframe;
+ 			}
+ 		}
+-- 
+2.30.2
+
diff --git a/video.h b/video.h
index aadabbe..bf93920 100644
--- a/video.h
+++ b/video.h
@@ -115,7 +115,6 @@ struct _Drm_Render_
 	int fd_drm;
 	drmModeModeInfo mode;
 	drmModeCrtc *saved_crtc;
-	drmEventContext ev;
 	struct {
 		int x;
 		int y;
diff --git a/video_drm.c b/video_drm.c
index 19fd378..461e4e3 100644
--- a/video_drm.c
+++ b/video_drm.c
@@ -1081,14 +1081,6 @@ static int SetupFB(VideoRender * render, struct drm_buf *buf,
 	return 0;
 }
 
-/*static void Drm_page_flip_event( __attribute__ ((unused)) int fd,
-					__attribute__ ((unused)) unsigned int frame,
-					__attribute__ ((unused)) unsigned int sec,
-					__attribute__ ((unused)) unsigned int usec,
-					__attribute__ ((unused)) void *data)
-{
-}*/
-
 static void DestroyFB(int fd_drm, struct drm_buf *buf)
 {
 	struct drm_mode_destroy_dumb dreq;
@@ -1478,9 +1470,6 @@ static void *DisplayHandlerThread(void * arg)
 
 		Frame2Display(render);
 
-		if (drmHandleEvent(render->fd_drm, &render->ev) != 0)
-			fprintf(stderr, "DisplayHandlerThread: drmHandleEvent failed!\n");
-
 /*#ifdef AV_SYNC_DEBUG
 		static uint32_t last_tick;
 		uint32_t tick;
@@ -2437,14 +2426,6 @@ void VideoInit(VideoRender * render)
 
 	render->OsdShown = 0;
 
-	// init variables page flip
-//    if (render->ev.page_flip_handler != Drm_page_flip_event) {
-		memset(&render->ev, 0, sizeof(render->ev));
-//		render->ev.version = DRM_EVENT_CONTEXT_VERSION;
-		render->ev.version = 2;
-//		render->ev.page_flip_handler = Drm_page_flip_event;
-//	}
-
 	// Wakeup DisplayHandlerThread
 	VideoThreadWakeup(render, 0, 1);
 }
-- 
2.30.2

